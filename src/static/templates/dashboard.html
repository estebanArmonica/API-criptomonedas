<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Criptomonedas con EMA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
        }
        
        .metric-item {
            padding: 0.75rem;
            border-radius: 8px;
            background-color: rgba(102, 126, 234, 0.05);
            margin-bottom: 0.5rem;
        }
        
        .opportunity-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .opportunity-card:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        .timeframe-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            border-right: 1px solid #eee;
        }
        
        .stat-item:last-child {
            border-right: none;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 10px;
        }
        
        .alert-offline {
            background-color: #fff3cd;
            border-left: 4px solid var(--warning-color);
        }
        
        .candle-chart-controls {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .notification-form {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .stat-item {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .stat-item:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="display-5 fw-bold">üìä Crypto Dashboard PRO</h1>
                    <p class="lead">An√°lisis con EMA y notificaciones autom√°ticas</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <button id="reloadBtn" class="btn btn-light me-2">
                        <span>üîÑ Actualizar</span>
                    </button>
                    <span id="lastUpdated" class="badge bg-light text-dark">√öltima actualizaci√≥n: --:--:--</span>
                </div>
                <!-- Bot√≥n para ir a la simulaci√≥n -->
                <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
                    <a href="/simulacion" style="text-decoration: none;">
                        <button style="background-color: #0ecb81; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            üéÆ Ir al Simulador
                        </button>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- M√©tricas Globales -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>üåç M√©tricas Globales del Mercado</span>
                    </div>
                    <div class="card-body">
                        <div id="globalMetrics" class="d-flex flex-wrap gap-3">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm"></div>
                                <p class="mt-2">Cargando m√©tricas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selector de Moneda y Filtros -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">Seleccionar Criptomoneda</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <select id="coinSelector" class="form-select">
                                    <option value="bitcoin" selected>Bitcoin (BTC)</option>
                                    <option value="ethereum">Ethereum (ETH)</option>
                                    <option value="binancecoin">BNB (BNB)</option>
                                    <option value="ripple">XRP (XRP)</option>
                                    <option value="cardano">Cardano (ADA)</option>
                                    <option value="solana">Solana (SOL)</option>
                                    <option value="polkadot">Polkadot (DOT)</option>
                                    <option value="dogecoin">Dogecoin (DOGE)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary timeframe-btn active" data-timeframe="1">1D</button>
                                    <button type="button" class="btn btn-outline-primary timeframe-btn" data-timeframe="7">7D</button>
                                    <button type="button" class="btn btn-outline-primary timeframe-btn" data-timeframe="30">30D</button>
                                    <button type="button" class="btn btn-outline-primary timeframe-btn" data-timeframe="90">90D</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Estad√≠sticas R√°pidas</div>
                    <div class="card-body p-0">
                        <div id="quickStats" class="d-flex flex-wrap">
                            <div class="text-center w-100 py-4">
                                <div class="spinner-border spinner-border-sm"></div>
                                <p class="mt-2">Cargando datos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de Velas -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>üìà Gr√°fico de Velas con EMA</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emaToggle" checked>
                            <label class="form-check-label" for="emaToggle">Mostrar EMA</label>
                        </div>
                    </div>
                    <div class="card-body position-relative" style="min-height: 500px;">
                        <div class="candle-chart-controls">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="emaPeriod" class="form-label">Per√≠odo EMA:</label>
                                    <input type="range" class="form-range" id="emaPeriod" min="5" max="50" value="20">
                                    <span id="emaPeriodValue">20 d√≠as</span>
                                </div>
                                <div class="col-md-4">
                                    <label for="futurePeriods" class="form-label">Predicci√≥n (d√≠as):</label>
                                    <input type="range" class="form-range" id="futurePeriods" min="1" max="10" value="5">
                                    <span id="futurePeriodsValue">5 d√≠as</span>
                                </div>
                                <div class="col-md-4">
                                    <button id="calculateEmaBtn" class="btn btn-primary mt-4">Calcular EMA</button>
                                </div>
                            </div>
                        </div>
                        <div id="candleChart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√±ales y Oportunidades -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">üìä Se√±ales de Trading con EMA</div>
                    <div class="card-body">
                        <div id="tradingSignals">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm"></div>
                                <p class="mt-2">Analizando se√±ales...</p>
                            </div>
                        </div>
                        <div id="tradeActions" class="mt-3 text-center"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">üîÆ Predicciones EMA</div>
                    <div class="card-body">
                        <div id="predictions">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm"></div>
                                <p class="mt-2">Generando predicciones...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notificaciones por Email -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">üìß Notificaciones por Correo</div>
                    <div class="card-body">
                        <div class="notification-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="emailInput" class="form-label">Correo electr√≥nico</label>
                                        <input type="email" class="form-control" id="emailInput" placeholder="tu@email.com">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="notificationType" class="form-label">Tipo de notificaci√≥n</label>
                                        <select class="form-select" id="notificationType">
                                            <option value="both" selected>Compra y Venta</option>
                                            <option value="buy">Solo Compra</option>
                                            <option value="sell">Solo Venta</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="enableNotifications">
                                <label class="form-check-label" for="enableNotifications">
                                    Activar notificaciones autom√°ticas
                                </label>
                            </div>
                            <button id="testNotificationBtn" class="btn btn-outline-primary me-2">Probar Notificaci√≥n</button>
                            <button id="saveSettingsBtn" class="btn btn-primary">Guardar Configuraci√≥n</button>
                        </div>
                        <div id="notificationStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Oportunidades de Inversi√≥n -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">üíé Oportunidades de Inversi√≥n</div>
                    <div class="card-body">
                        <div id="opportunities">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm"></div>
                                <p class="mt-2">Buscando oportunidades...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CryptoDashboard {
            constructor() {
                this.currentCoin = 'bitcoin';
                this.currentData = null;
                this.useDemoMode = false;
                this.emaPeriod = 20;
                this.futurePeriods = 5;
                this.ohlcData = [];
                this.emaData = [];
                this.futureEmaData = [];
                this.init();
            }

            async init() {
                console.log("üöÄ Inicializando dashboard con gr√°fico de velas...");
                this.updateLastUpdatedTime();
                await this.loadGlobalMetrics();
                await this.loadOpportunities();
                this.setupEventListeners();
                await this.loadCoinData(this.currentCoin, 30);
                
                // Actualizar cada 2 minutos
                setInterval(() => {
                    this.reloadAllData();
                }, 120000);
            }

            setupEventListeners() {
                // Selector de moneda
                const coinSelector = document.getElementById('coinSelector');
                if (coinSelector) {
                    coinSelector.addEventListener('change', (e) => {
                        this.currentCoin = e.target.value;
                        this.loadCoinData(this.currentCoin, 30);
                    });
                }

                // Bot√≥n de recarga
                const reloadBtn = document.getElementById('reloadBtn');
                if (reloadBtn) {
                    reloadBtn.addEventListener('click', () => {
                        this.reloadAllData();
                    });
                }

                // Botones de timeframe
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        const timeframe = parseInt(this.getAttribute('data-timeframe'));
                        dashboard.loadCoinData(dashboard.currentCoin, timeframe);
                    });
                });

                // Controles EMA
                document.getElementById('emaPeriod').addEventListener('input', function() {
                    document.getElementById('emaPeriodValue').textContent = this.value + ' d√≠as';
                    dashboard.emaPeriod = parseInt(this.value);
                });

                document.getElementById('futurePeriods').addEventListener('input', function() {
                    document.getElementById('futurePeriodsValue').textContent = this.value + ' d√≠as';
                    dashboard.futurePeriods = parseInt(this.value);
                });

                document.getElementById('calculateEmaBtn').addEventListener('click', () => {
                    this.calculateEMA();
                    this.renderCandleChart();
                });

                document.getElementById('emaToggle').addEventListener('change', () => {
                    this.renderCandleChart();
                });

                // Notificaciones
                document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                    this.saveNotificationSettings();
                });

                document.getElementById('testNotificationBtn').addEventListener('click', () => {
                    this.sendTestNotification();
                });
            }

            updateLastUpdatedTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                document.getElementById('lastUpdated').textContent = `√öltima actualizaci√≥n: ${timeString}`;
            }

            async reloadAllData() {
                console.log("üîÑ Recargando todos los datos...");
                this.useDemoMode = false;
                
                // Mostrar indicadores de carga
                this.showLoadingState('globalMetrics', 'opportunities', 'tradingSignals', 'predictions');
                await this.loadGlobalMetrics();
                await this.loadOpportunities();
                await this.loadCoinData(this.currentCoin, 30);
                this.updateLastUpdatedTime();
            }

            async loadGlobalMetrics() {
                try {
                    console.log("üìä Cargando m√©tricas globales...");
                    
                    // En una implementaci√≥n real, aqu√≠ se conectar√≠a a una API
                    // Por ahora usamos datos de demostraci√≥n
                    const metrics = {
                        total_market_cap: 2500000000000,
                        total_volume: 100000000000,
                        market_cap_change_24h: 2.5,
                        active_cryptocurrencies: 10000,
                        timestamp: new Date().toISOString()
                    };
                    
                    this.renderGlobalMetrics(metrics);
                    
                } catch (error) {
                    console.error('Error loading global metrics:', error);
                    this.showDemoGlobalMetrics();
                    this.useDemoMode = true;
                }
            }

            renderGlobalMetrics(data) {
                const globalMetrics = document.getElementById('globalMetrics');
                if (!globalMetrics) return;

                // Aseg√∫rate de que market_cap_change_24h sea un n√∫mero
                const marketCapChange = parseFloat(data.market_cap_change_24h) || 0;
                
                const metricsHtml = `
                    <div class="metric-item">
                        <small>Market Cap Total:</small>
                        <strong>$${this.formatNumber(data.total_market_cap)}</strong>
                    </div>
                    <div class="metric-item">
                        <small>Volumen 24h:</small>
                        <strong>$${this.formatNumber(data.total_volume)}</strong>
                    </div>
                    <div class="metric-item">
                        <small>Cambio 24h:</small>
                        <strong class="${data.market_cap_change_24h >= 0 ? 'text-success' : 'text-danger'}">
                            ${data.market_cap_change_24h?.toFixed(2) || '0.00'}%
                        </strong>
                    </div>
                    <div class="metric-item">
                        <small>Criptomonedas:</small>
                        <strong>${this.formatNumber(data.active_cryptocurrencies)}</strong>
                    </div>
                    ${this.useDemoMode ? '<div class="alert alert-warning mt-2"><small>‚ö†Ô∏è Usando datos en tiempo real</small></div>' : ''}
                `;
                
                globalMetrics.innerHTML = metricsHtml;
            }

            showDemoGlobalMetrics() {
                const globalMetrics = document.getElementById('globalMetrics');
                if (!globalMetrics) return;
                
                const demoHtml = `
                    <div class="alert alert-warning">
                        <small>‚ö†Ô∏è Modo offline: Datos simulados</small>
                        <button onclick="dashboard.reloadAllData()" class="btn btn-sm btn-outline-warning ms-2">
                            Reintentar
                        </button>
                    </div>
                    <div class="metric-item">
                        <small>Market Cap Total:</small>
                        <strong>$1.5T</strong>
                    </div>
                    <div class="metric-item">
                        <small>Volumen 24h:</small>
                        <strong>$50B</strong>
                    </div>
                    <div class="metric-item">
                        <small>Cambio 24h:</small>
                        <strong class="text-success">+2.5%</strong>
                    </div>
                    <div class="metric-item">
                        <small>Criptomonedas:</small>
                        <strong>10,000</strong>
                    </div>
                `;
                globalMetrics.innerHTML = demoHtml;
            }

            async loadCoinData(coinId, days = 30) {
                try {
                    console.log(`üìà Cargando datos de ${coinId}...`);
                    this.showLoadingState('tradingSignals', 'predictions');

                    // En una implementaci√≥n real, aqu√≠ se conectar√≠a a una API
                    // Por ahora generamos datos de demostraci√≥n
                    const data = await this.generateDemoData(coinId, days);
                    this.currentData = data;

                    this.renderQuickStats(data);
                    this.calculateEMA();
                    this.renderCandleChart();
                    this.renderTradingSignals(data);
                    this.renderPredictions(data);
                    this.useDemoMode = false;
                    
                } catch (error) {
                    console.error('Error loading coin data:', error);
                    this.showDemoCoinData(coinId);
                    this.useDemoMode = true;
                }
            }

            async generateDemoData(coinId, days) {
                // Precios base seg√∫n la moneda
                const basePrices = {
                    'bitcoin': 45000,
                    'ethereum': 3000,
                    'binancecoin': 350,
                    'ripple': 0.5,
                    'cardano': 1.2,
                    'solana': 100,
                    'polkadot': 20,
                    'dogecoin': 0.15
                };
                
                const basePrice = basePrices[coinId] || 100;
                const now = Date.now();
                const ohlcData = [];
                
                // Generar datos OHLC (Open, High, Low, Close) para el gr√°fico de velas
                for (let i = days; i >= 0; i--) {
                    const date = new Date(now - i * 86400000);
                    const open = basePrice * (0.95 + Math.random() * 0.1);
                    const close = open * (0.97 + Math.random() * 0.06);
                    const high = Math.max(open, close) * (1 + Math.random() * 0.03);
                    const low = Math.min(open, close) * (0.97 + Math.random() * 0.03);
                    
                    ohlcData.push({
                        timestamp: date.toISOString(),
                        open: open,
                        high: high,
                        low: low,
                        close: close,
                        volume: 1000000 * (0.8 + Math.random() * 0.4)
                    });
                }
                
                this.ohlcData = ohlcData;
                
                const currentClose = ohlcData[ohlcData.length - 1].close;
                const previousClose = ohlcData[ohlcData.length - 2].close;
                const priceChange24h = ((currentClose - previousClose) / previousClose) * 100;

                return {
                    coin_id: coinId,
                    current_price: ohlcData[ohlcData.length - 1].close,
                    price_change_24h: ((ohlcData[ohlcData.length - 1].close - ohlcData[ohlcData.length - 2].close) / ohlcData[ohlcData.length - 2].close * 100),
                    market_cap: basePrice * (coinId === 'bitcoin' ? 19000000 : 100000000),
                    volume_24h: basePrice * (coinId === 'bitcoin' ? 500000 : 2000000),
                    historical_data: ohlcData
                };
            }

            calculateEMA() {
                if (!this.ohlcData || this.ohlcData.length === 0) return;
                
                const closingPrices = this.ohlcData.map(item => item.close);
                const period = this.emaPeriod;
                
                // Calcular EMA
                let emaValues = [];
                const k = 2 / (period + 1);
                
                // Primer valor EMA es el promedio simple de los primeros 'period' valores
                let sum = 0;
                for (let i = 0; i < period; i++) {
                    sum += closingPrices[i];
                }
                emaValues.push(sum / period);
                
                // Calcular EMA para los valores restantes
                for (let i = period; i < closingPrices.length; i++) {
                    const ema = closingPrices[i] * k + emaValues[emaValues.length - 1] * (1 - k);
                    emaValues.push(ema);
                }
                
                // Asignar fechas a los valores EMA
                this.emaData = [];
                for (let i = 0; i < emaValues.length; i++) {
                    this.emaData.push({
                        timestamp: this.ohlcData[i + period - 1].timestamp,
                        value: emaValues[i]
                    });
                }
                
                // Calcular predicci√≥n futura
                this.calculateFutureEMA(closingPrices, emaValues);
                
                console.log("EMA calculada para per√≠odo:", period);
            }

            calculateFutureEMA(closingPrices, emaValues) {
                const period = this.emaPeriod;
                const futurePeriods = this.futurePeriods;
                const k = 2 / (period + 1);
                
                // Usar el √∫ltimo valor EMA como base para la predicci√≥n
                let lastEma = emaValues[emaValues.length - 1];
                this.futureEmaData = [];
                
                // Crear fechas futuras
                const lastDate = new Date(this.ohlcData[this.ohlcData.length - 1].timestamp);
                
                for (let i = 1; i <= futurePeriods; i++) {
                    // Simular un precio futuro basado en la tendencia reciente
                    const recentTrend = closingPrices[closingPrices.length - 1] - closingPrices[closingPrices.length - 5];
                    const simulatedPrice = closingPrices[closingPrices.length - 1] + (recentTrend / 5) * i;
                    
                    // Calcular EMA para el precio simulado
                    const futureEma = simulatedPrice * k + lastEma * (1 - k);
                    lastEma = futureEma;
                    
                    // Crear fecha futura
                    const futureDate = new Date(lastDate);
                    futureDate.setDate(futureDate.getDate() + i);
                    
                    this.futureEmaData.push({
                        timestamp: futureDate.toISOString(),
                        value: futureEma
                    });
                }
            }

            renderCandleChart() {
                const chartDiv = document.getElementById('candleChart');
                if (!chartDiv) return;
                
                if (!this.ohlcData || this.ohlcData.length === 0) {
                    chartDiv.innerHTML = `
                        <div class="alert alert-info">
                            <p>üìä Gr√°fico no disponible</p>
                            <small>No hay datos hist√≥ricos</small>
                        </div>
                    `;
                    return;
                }

                try {
                    // Preparar datos para el gr√°fico de velas
                    const dates = this.ohlcData.map(item => item.timestamp);
                    const opens = this.ohlcData.map(item => item.open);
                    const highs = this.ohlcData.map(item => item.high);
                    const lows = this.ohlcData.map(item => item.low);
                    const closes = this.ohlcData.map(item => item.close);
                    
                    // Determinar colores (verde para subida, rojo para bajada)
                    const colors = closes.map((close, i) => {
                        return i === 0 ? '#17a2b8' : (close >= opens[i] ? '#28a745' : '#dc3545');
                    });

                    // Datos para el gr√°fico de velas
                    const candleData = [{
                        type: 'candlestick',
                        x: dates,
                        open: opens,
                        high: highs,
                        low: lows,
                        close: closes,
                        yaxis: 'y2',
                        name: 'Precio',
                        increasing: {line: {color: '#28a745'}},
                        decreasing: {line: {color: '#dc3545'}}
                    }];

                    // Agregar l√≠nea de EMA si est√° activado
                    if (document.getElementById('emaToggle').checked && this.emaData.length > 0) {
                        candleData.push({
                            x: this.emaData.map(item => item.timestamp),
                            y: this.emaData.map(item => item.value),
                            type: 'scatter',
                            mode: 'lines',
                            name: `EMA (${this.emaPeriod})`,
                            line: {color: '#667eea', width: 2},
                            yaxis: 'y2'
                        });
                        
                        // Agregar predicci√≥n futura de EMA
                        if (this.futureEmaData.length > 0) {
                            candleData.push({
                                x: this.futureEmaData.map(item => item.timestamp),
                                y: this.futureEmaData.map(item => item.value),
                                type: 'scatter',
                                mode: 'lines',
                                name: `Predicci√≥n EMA`,
                                line: {color: '#ff9900', width: 2, dash: 'dash'},
                                yaxis: 'y2'
                            });
                        }
                    }

                    const layout = {
                        title: {
                            text: `Gr√°fico de Velas - ${this.currentCoin.toUpperCase()} con EMA ${this.emaPeriod}`,
                            font: { size: 18, family: 'Arial', color: '#2c3e50' }
                        },
                        xaxis: {
                            title: 'Fecha',
                            type: 'date',
                            rangeslider: { visible: false }
                        },
                        yaxis: {
                            title: 'Volumen',
                            side: 'left',
                            showgrid: false
                        },
                        yaxis2: {
                            title: 'Precio (USD)',
                            side: 'right',
                            overlaying: 'y',
                            showgrid: true,
                            tickprefix: '$'
                        },
                        showlegend: true,
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        margin: { l: 60, r: 60, t: 60, b: 50 },
                        font: { family: 'Arial', size: 12 }
                    };

                    const config = {
                        responsive: true,
                        displayModeBar: true,
                        displaylogo: false,
                        modeBarButtonsToAdd: ['hoverClosestGl2d'],
                        modeBarButtonsToRemove: ['autoScale2d', 'toggleSpikelines'],
                        scrollZoom: true
                    };

                    Plotly.newPlot('candleChart', candleData, layout, config);
                } catch (error) {
                    console.error('Error rendering candle chart:', error);
                    chartDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <p>‚ö†Ô∏è Error mostrando gr√°fico</p>
                            <small>${error.message}</small>
                        </div>
                    `;
                }
            }

            renderQuickStats(data) {
                const quickStats = document.getElementById('quickStats');
                if (!quickStats || !data) return;

                // aseguramos que price_change_24h sea un numero
                const priceChange = parseFloat(data.price_change_24h) || 0;

                const statsHtml = `
                    <div class="stat-item">
                        <small>Precio Actual</small>
                        <h4 class="mb-0">$${data.current_price?.toFixed(2) || '0.00'}</h4>
                    </div>
                    <div class="stat-item">
                        <small>Cambio 24h</small>
                        <h4 class="mb-0 ${data.price_change_24h >= 0 ? 'text-success' : 'text-danger'}">
                            ${data.price_change_24h?.toFixed(2) || '0.00'}%
                        </h4>
                    </div>
                    <div class="stat-item">
                        <small>Market Cap</small>
                        <h4 class="mb-0">$${this.formatNumber(data.market_cap)}</h4>
                    </div>
                    <div class="stat-item">
                        <small>Volumen 24h</small>
                        <h4 class="mb-0">$${this.formatNumber(data.volume_24h)}</h4>
                    </div>
                `;

                quickStats.innerHTML = statsHtml;
            }

            // redireccion a la p√°gina de simulacion
            executeTrade(type) {
                // Redirigir a la p√°gina de simulaci√≥n con par√°metros
                const params = new URLSearchParams({
                    coin: this.currentCoin,
                    action: type,
                    price: this.ohlcData[this.ohlcData.length - 1].close.toFixed(2)
                });

                window.location.href = `simulacion?${params.toString()}`;
            }

            renderTradingSignals(data) {
                const signalsDiv = document.getElementById('tradingSignals');
                const tradeActionsDiv = document.getElementById('tradeActions');

                if (!signalsDiv) return;

                // Generar se√±ales basadas en EMA
                const signals = this.generateEMASignals();

                let signalsHtml = '<h6>Se√±ales de Trading en Tiempo Real:</h6>';
                tradeActionsDiv.innerHTML = '';

                if (signals.length === 0) {
                    signalsHtml += `
                        <div class="alert alert-info">
                            <p>No hay se√±ales fuertes en este momento</p>
                            <small>Esperando cruces significativos de EMA</small>
                        </div>
                    `;
                } else {
                    signals.forEach(signal => {
                        const alertClass = signal.type === 'BUY' ? 'alert-success' : 'alert-danger';

                        signalsHtml += `
                            <div class="alert ${alertClass}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">${signal.type} 
                                            <span class="badge bg-${signal.confidence === 'high' ? 'success' : signal.confidence === 'medium' ? 'warning' : 'secondary'}">
                                                ${signal.confidence.toUpperCase()}
                                            </span>
                                        </h6>
                                        <p class="mb-1">${signal.reason}</p>
                                        <small class="text-muted">${new Date(signal.timestamp).toLocaleString()}</small>
                                    </div>
                                </div>
                            </div>
                        `;

                        // mostramos el boton de comprar/vender seg√∫n la se√±al
                        if (signal.type === 'BUY') {
                            tradeActionsDiv.innerHTML = `
                                <button class="btn btn-success" id="buyBtn" 
                                    onclick="dashboard.executeTrade('buy')">
                                    Comprar ${this.currentCoin}
                                </button>`;
                        } else if (signal.type === 'SELL') {
                            tradeActionsDiv.innerHTML = `
                                <button class="btn btn-danger" id="sellBtn" 
                                    onclick="dashboard.executeTrade('sell')">
                                    Vender ${this.currentCoin}
                                </button>`;
                        }
                    });
                }

                signalsDiv.innerHTML = signalsHtml;
            }

            generateEMASignals() {
                const signals = [];
                if (this.emaData.length < 2) return signals;
                
                const currentPrice = this.ohlcData[this.ohlcData.length - 1].close;
                const currentEma = this.emaData[this.emaData.length - 1].value;
                const previousEma = this.emaData[this.emaData.length - 2].value;
                const priceVsEma = ((currentPrice - currentEma) / currentEma) * 100;
                
                // Se√±al de compra: precio cruza por encima de la EMA
                if (currentPrice > currentEma && this.ohlcData[this.ohlcData.length - 2].close <= previousEma) {
                    signals.push({
                        type: 'BUY',
                        confidence: Math.abs(priceVsEma) > 2 ? 'high' : 'medium',
                        reason: `Precio cruz√≥ por encima de la EMA${this.emaPeriod}. El precio est√° ${Math.abs(priceVsEma).toFixed(2)}% por encima de la EMA.`,
                        price: currentPrice,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Se√±al de venta: precio cruza por debajo de la EMA
                if (currentPrice < currentEma && this.ohlcData[this.ohlcData.length - 2].close >= previousEma) {
                    signals.push({
                        type: 'SELL',
                        confidence: Math.abs(priceVsEma) > 2 ? 'high' : 'medium',
                        reason: `Precio cruz√≥ por debajo de la EMA${this.emaPeriod}. El precio est√° ${Math.abs(priceVsEma).toFixed(2)}% por debajo de la EMA.`,
                        price: currentPrice,
                        timestamp: new Date().toISOString()
                    });
                }
                
                return signals;
            }

            renderPredictions(data) {
                const predictionsDiv = document.getElementById('predictions');
                if (!predictionsDiv) return;
                
                if (!this.futureEmaData || this.futureEmaData.length === 0) {
                    predictionsDiv.innerHTML = `
                        <div class="alert alert-info">
                            <h6>üîÆ Predicciones EMA</h6>
                            <p>No hay predicciones disponibles</p>
                            <small>Calcule la EMA para ver predicciones</small>
                        </div>
                    `;
                    return;
                }

                const currentPrice = this.ohlcData[this.ohlcData.length - 1].close;
                const lastPrediction = this.futureEmaData[this.futureEmaData.length - 1].value;
                const changePercentage = ((lastPrediction - currentPrice) / currentPrice) * 100;
                const trend = changePercentage >= 0 ? 'alcista' : 'bajista';
                
                let predictionsHtml = `
                    <h6>Predicci√≥n para ${this.futurePeriods} d√≠as:</h6>
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title ${changePercentage >= 0 ? 'text-success' : 'text-danger'}">
                                ${changePercentage >= 0 ? 'üìà' : 'üìâ'} ${Math.abs(changePercentage).toFixed(2)}%
                            </h5>
                            <p class="card-text">
                                Tendencia ${trend} esperada seg√∫n EMA${this.emaPeriod}.
                            </p>
                            <div class="row">
                                <div class="col-6">
                                    <small>Precio actual:</small>
                                    <p class="mb-0 fw-bold">$${currentPrice.toFixed(2)}</p>
                                </div>
                                <div class="col-6">
                                    <small>Predicci√≥n:</small>
                                    <p class="mb-0 fw-bold">$${lastPrediction.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                predictionsDiv.innerHTML = predictionsHtml;
            }

            showDemoCoinData(coinId) {
                // Similar a la implementaci√≥n anterior pero adaptada para el gr√°fico de velas
                const basePrice = coinId === 'bitcoin' ? 45000 : 
                                coinId === 'ethereum' ? 3000 : 
                                coinId === 'binancecoin' ? 350 : 100;
                
                const demoData = {
                    coin_id: coinId,
                    current_price: basePrice,
                    price_change_24h: (Math.random() * 10 - 5).toFixed(2),
                    market_cap: basePrice * (coinId === 'bitcoin' ? 19000000 : 100000000),
                    volume_24h: basePrice * (coinId === 'bitcoin' ? 500000 : 2000000),
                    historical_data: this.generateDemoHistoricalData(coinId, basePrice)
                };

                this.ohlcData = demoData.historical_data;
                this.renderQuickStats(demoData);
                this.calculateEMA();
                this.renderCandleChart();
                
                // Mostrar advertencia
                const tradingSignals = document.getElementById('tradingSignals');
                if (tradingSignals) {
                    tradingSignals.innerHTML += `
                        <div class="alert alert-warning mt-3">
                            <small>‚ö†Ô∏è Modo offline: Datos simulados</small>
                            <button onclick="dashboard.loadCoinData('${coinId}')" class="btn btn-sm btn-outline-warning ms-2">
                                Reintentar
                            </button>
                        </div>
                    `;
                }
            }

            generateDemoHistoricalData(coinId, basePrice = null) {
                const price = basePrice || (coinId === 'bitcoin' ? 45000 : 
                                 coinId === 'ethereum' ? 3000 : 100);
                
                const data = [];
                const now = Date.now();
                
                for (let i = 30; i >= 0; i--) {
                    const timestamp = new Date(now - i * 86400000).toISOString();
                    const open = price * (0.95 + Math.random() * 0.1);
                    const close = open * (0.97 + Math.random() * 0.06);
                    const high = Math.max(open, close) * (1 + Math.random() * 0.03);
                    const low = Math.min(open, close) * (0.97 + Math.random() * 0.03);
                    
                    data.push({
                        timestamp: timestamp,
                        open: open,
                        high: high,
                        low: low,
                        close: close,
                        volume: 1000000 * (0.8 + Math.random() * 0.4)
                    });
                }
                
                return data;
            }

            async loadOpportunities() {
                // Implementaci√≥n similar a la anterior
                try {
                    console.log("üíé Buscando oportunidades...");
                    // En una implementaci√≥n real, aqu√≠ se conectar√≠a a una API
                    await this.loadCoinGeckoOpportunities();
                } catch (error) {
                    console.error('Error loading opportunities:', error);
                    this.showDemoOpportunities();
                }
            }

            async loadCoinGeckoOpportunities() {
                try {
                    // Simular obtenci√≥n de oportunidades
                    const opportunities = [
                        {
                            coin: {
                                id: 'bitcoin',
                                name: 'Bitcoin',
                                symbol: 'btc',
                                current_price: 45000,
                                price_change_percentage_24h: 2.5
                            },
                            signal: {
                                type: 'BUY',
                                confidence: 'high',
                                reason: 'Fuerte soporte en EMA20, RSI en zona de sobreventa',
                                price: 45000,
                                timestamp: new Date().toISOString()
                            }
                        },
                        {
                            coin: {
                                id: 'ethereum',
                                name: 'Ethereum',
                                symbol: 'eth',
                                current_price: 3000,
                                price_change_percentage_24h: -1.2
                            },
                            signal: {
                                type: 'HOLD',
                                confidence: 'medium',
                                reason: 'Consolidaci√≥n en curso, esperar se√±al m√°s clara',
                                price: 3000,
                                timestamp: new Date().toISOString()
                            }
                        }
                    ];
                    
                    this.renderOpportunities(opportunities);
                    
                } catch (error) {
                    console.error('Error loading CoinGecko opportunities:', error);
                    this.showDemoOpportunities();
                }
            }

            renderOpportunities(opportunities) {
                const opportunitiesDiv = document.getElementById('opportunities');
                if (!opportunitiesDiv) return;
                
                let opportunitiesHtml = `
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <small>üíé Oportunidades detectadas basadas en EMA</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                `;
                
                opportunities.forEach(opp => {
                    const coin = opp.coin || {};
                    const signal = opp.signal || {};
                    
                    opportunitiesHtml += `
                        <div class="col-md-4 mb-3">
                            <div class="card opportunity-card" onclick="dashboard.loadCoinData('${coin.id || 'bitcoin'}')">
                                <div class="card-body">
                                    <h6 class="card-title">${coin.name || 'Unknown'} 
                                        <small class="text-muted">(${coin.symbol ? coin.symbol.toUpperCase() : 'N/A'})</small>
                                    </h6>
                                    <p class="card-text mb-1">
                                        <span class="fw-bold">$${coin.current_price ? coin.current_price.toFixed(2) : '0.00'}</span>
                                        <span class="${coin.price_change_percentage_24h >= 0 ? 'text-success' : 'text-danger'} small ms-2">
                                            ${coin.price_change_percentage_24h ? coin.price_change_percentage_24h.toFixed(1) + '%' : ''}
                                        </span>
                                    </p>
                                    <p class="card-text">
                                        <span class="badge bg-${signal.type === 'BUY' ? 'success' : signal.type === 'SELL' ? 'danger' : 'warning'}">
                                            ${signal.type || 'HOLD'}
                                        </span>
                                        <small class="text-muted ms-1">(${signal.confidence || 'MEDIUM'})</small>
                                    </p>
                                    <p class="card-text small text-muted">
                                        ${signal.reason ? signal.reason.substring(0, 50) + '...' : 'Analizando oportunidad...'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                opportunitiesHtml += '</div>';
                opportunitiesDiv.innerHTML = opportunitiesHtml;
            }

            showDemoOpportunities() {
                const demoOpportunities = [
                    {
                        coin: {id: 'bitcoin', name: 'Bitcoin', symbol: 'btc', current_price: 45000, price_change_percentage_24h: 2.5},
                        signal: {type: 'BUY', confidence: 'high', reason: 'Precio en soporte t√©cnico fuerte, RSI en sobreventa'}
                    },
                    {
                        coin: {id: 'ethereum', name: 'Ethereum', symbol: 'eth', current_price: 3000, price_change_percentage_24h: -1.2},
                        signal: {type: 'HOLD', confidence: 'medium', reason: 'Mercado lateral, esperar se√±al m√°s clara'}
                    }
                ];
                
                this.renderOpportunities(demoOpportunities);
            }

            showLoadingState(...elementIds) {
                elementIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = `
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm"></div>
                                <p class="mt-2">Cargando datos en tiempo real...</p>
                            </div>
                        `;
                    }
                });
            }

            saveNotificationSettings() {
                const email = document.getElementById('emailInput').value;
                const notificationType = document.getElementById('notificationType').value;
                const enabled = document.getElementById('enableNotifications').checked;
                
                if (!email || !this.validateEmail(email)) {
                    this.showNotificationStatus('Por favor, introduce un email v√°lido', 'danger');
                    return;
                }
                
                // En una implementaci√≥n real, aqu√≠ se guardar√≠an estas configuraciones
                // en una base de datos o se enviar√≠an a un servidor
                
                localStorage.setItem('cryptoNotificationEmail', email);
                localStorage.setItem('cryptoNotificationType', notificationType);
                localStorage.setItem('cryptoNotificationsEnabled', enabled);
                
                this.showNotificationStatus('Configuraci√≥n guardada correctamente. Las notificaciones est√°n ' + (enabled ? 'activadas' : 'desactivadas'), 'success');
            }

            sendTestNotification() {
                const email = document.getElementById('emailInput').value;
                
                if (!email || !this.validateEmail(email)) {
                    this.showNotificationStatus('Por favor, introduce un email v√°lido', 'danger');
                    return;
                }
                
                // En una implementaci√≥n real, aqu√≠ se conectar√≠a con un servicio de env√≠o de emails
                this.showNotificationStatus('Email de prueba enviado a ' + email, 'success');
                
                // Simular env√≠o de email
                setTimeout(() => {
                    alert(`üìß Email de prueba enviado a ${email}\nAsunto: Prueba de notificaciones de trading\nContenido: Esta es una prueba del sistema de notificaciones. Cuando se detecten se√±ales de compra/venta, recibir√°s un email similar.`);
                }, 1000);
            }

            showNotificationStatus(message, type) {
                const statusDiv = document.getElementById('notificationStatus');
                statusDiv.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }

            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            formatNumber(num) {
                if (num === undefined || num === null) return '0.00';
                const number = parseFloat(num);
                if (isNaN(number)) return '0.00';
                
                if (number >= 1e9) return (number / 1e9).toFixed(2) + 'B';
                if (number >= 1e6) return (number / 1e6).toFixed(2) + 'M';
                if (number >= 1e3) return (number / 1e3).toFixed(2) + 'K';
                return number.toFixed(2);
            }
        }

        // Inicializar dashboard cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            window.dashboard = new CryptoDashboard();
        });
    </script>
</body>
</html>