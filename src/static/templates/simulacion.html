<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Trading - CryptoAnalytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0c1426;
            --bg-secondary: #17203d;
            --bg-tertiary: #1b2a4e;
            --text-primary: #eaecef;
            --text-secondary: #848e9c;
            --green: #0ecb81;
            --red: #f6465d;
            --border-color: #2a3653;
            --blue: #3b82f6;
            --purple: #8b5cf6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--green);
        }
        
        .pair-info {
            text-align: center;
        }
        
        .pair-name {
            font-size: 22px;
            font-weight: bold;
        }
        
        .pair-change {
            font-size: 16px;
            font-weight: bold;
        }
        
        .change-positive {
            color: var(--green);
        }
        
        .change-negative {
            color: var(--red);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        .chart-container {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            height: 450px;
            position: relative;
        }
        
        .timeframe-selector {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
            display: flex;
            gap: 5px;
            background-color: var(--bg-tertiary);
            padding: 5px;
            border-radius: 4px;
        }
        
        .timeframe-btn {
            padding: 4px 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .timeframe-btn.active {
            background-color: var(--green);
            color: white;
        }
        
        .order-book {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .order-section {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
        }
        
        .section-title {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }
        
        .order-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .order-table th, .order-table td {
            padding: 8px 5px;
            text-align: right;
            font-size: 13px;
        }
        
        .order-table th:first-child, .order-table td:first-child {
            text-align: left;
        }
        
        .buy-price {
            color: var(--green);
        }
        
        .sell-price {
            color: var(--red);
        }
        
        .trade-panel {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
        }
        
        .trade-type {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .trade-type-btn {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: bold;
        }
        
        .trade-type-btn.active {
            color: var(--text-primary);
            border-bottom: 2px solid var(--green);
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .balance-info {
            background-color: var(--bg-tertiary);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .action-btn {
            width: 100%;
            padding: 12px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: opacity 0.2s;
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .buy-btn {
            background-color: var(--green);
            color: white;
        }
        
        .sell-btn {
            background-color: var(--red);
            color: white;
        }
        
        .orders-container {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .tab.active {
            color: var(--text-primary);
            border-bottom: 2px solid var(--green);
        }
        
        .positions {
            margin-top: 20px;
        }
        
        .position-card {
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .position-info {
            flex: 1;
        }
        
        .position-pair {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .position-details {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .position-profit {
            font-weight: bold;
        }
        
        .profit-positive {
            color: var(--green);
        }
        
        .profit-negative {
            color: var(--red);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-secondary);
        }
        
        .loading::after {
            content: "";
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .indicators-control {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            background-color: var(--bg-tertiary);
            padding: 5px;
            border-radius: 4px;
        }
        
        .indicator-toggle {
            padding: 4px 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .indicator-toggle.active {
            background-color: var(--blue);
            color: white;
        }
        
        .trade-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            z-index: 20;
        }
        
        .buy-marker {
            background-color: var(--green);
            border: 2px solid white;
        }
        
        .sell-marker {
            background-color: var(--red);
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">CryptoAnalytics</div>
            <div class="pair-info">
                <div id="pair-name" class="pair-name">Seleccionando...</div>
                <div id="price-change" class="pair-change">+0.00%</div>
            </div>
            <div class="user-info">
                <span id="balance-display">Balance: $10,000.00</span>
            </div>
            <button onclick="location.href='dashboard'">Volver al Dashboard</button>
        </header>
        
        <div class="main-content">
            <div class="left-panel">
                <div class="chart-container">
                    <div class="timeframe-selector">
                        <button class="timeframe-btn active" data-timeframe="1">1m</button>
                        <button class="timeframe-btn" data-timeframe="5">5m</button>
                        <button class="timeframe-btn" data-timeframe="15">15m</button>
                        <button class="timeframe-btn" data-timeframe="30">30m</button>
                        <button class="timeframe-btn" data-timeframe="60">1h</button>
                    </div>
                    <div class="indicators-control">
                        <button class="indicator-toggle active" data-indicator="ema">EMA</button>
                    </div>
                    <canvas id="priceChart"></canvas>
                </div>
                
                <div class="order-book">
                    <div class="order-section">
                        <div class="section-title">Órdenes de Compra</div>
                        <table class="order-table">
                            <thead>
                                <tr>
                                    <th>Precio (USDT)</th>
                                    <th>Monto</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="buy-orders">
                                <tr><td colspan="3" class="loading">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="order-section">
                        <div class="section-title">Órdenes de Venta</div>
                        <table class="order-table">
                            <thead>
                                <tr>
                                    <th>Precio (USDT)</th>
                                    <th>Monto</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="sell-orders">
                                <tr><td colspan="3" class="loading">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="orders-container">
                    <div class="tabs">
                        <div class="tab active">Posiciones Abiertas</div>
                        <div class="tab">Órdenes Activas</div>
                        <div class="tab">Historial</div>
                    </div>
                    
                    <div class="positions" id="positions-container">
                        <div class="loading">Cargando posiciones...</div>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="trade-panel">
                    <div class="trade-type">
                        <button class="trade-type-btn active" data-type="limit">Limit Order</button>
                        <button class="trade-type-btn" data-type="market">Market Order</button>
                    </div>
                    
                    <div class="input-group">
                        <label for="price">Precio (USDT)</label>
                        <input type="number" id="price" value="0.00" step="0.00001">
                    </div>
                    
                    <div class="input-group">
                        <label for="amount">Cantidad</label>
                        <input type="number" id="amount" value="0.00" step="0.00001">
                    </div>
                    
                    <div class="input-group">
                        <label for="total">Total (USDT)</label>
                        <input type="number" id="total" value="0.00" readonly>
                    </div>
                    
                    <div class="balance-info">
                        Disponible: <span id="available-usdt">0.00</span> USDT
                    </div>
                    
                    <button class="action-btn buy-btn" id="buy-btn">Comprar</button>
                    
                    <div class="balance-info">
                        Disponible: <span id="available-crypto">0.00</span>
                    </div>
                    
                    <button class="action-btn sell-btn" id="sell-btn">Vender</button>
                </div>
                
                <div class="trade-panel" style="margin-top: 20px;">
                    <div class="section-title">Simulación de Resultados</div>
                    <div class="balance-info">
                        <div>Inversión inicial: $10,000.00</div>
                        <div>Ganancia/Pérdida: <span id="profit-loss">$0.00</span></div>
                        <div>Rendimiento: <span id="return">0.00%</span></div>
                        <div>Comisiones pagadas: $0.00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos iniciales de ejemplo
        const initialData = {
            balance: 10000,
            currentPrice: 0,
            positions: [],
            tradeHistory: [],
            buyOrders: [],
            sellOrders: [],
            priceHistory: [],
            priceChange24h: 0,
            timeframe: '1', // 1 minuto por defecto
            showEMA: true,
            tradeMarkers: []
        };

        // Estado de la aplicación
        let appState = {...initialData};
        let selectedCoin = 'bitcoin';
        let tradeAction = 'buy'; // 'buy' o 'sell'
        let chart = null;
        let updateInterval = null;
        let priceUpdateInterval = null;

        // Precios base según la moneda (debe coincidir con el dashboard)
        const basePrices = {
            'bitcoin': 45000,
            'ethereum': 3000,
            'binancecoin': 350,
            'ripple': 0.5,
            'cardano': 1.2,
            'solana': 100,
            'polkadot': 20,
            'dogecoin': 0.15
        };

        // Símbolos de las criptomonedas
        const coinSymbols = {
            'bitcoin': 'BTC',
            'ethereum': 'ETH',
            'binancecoin': 'BNB',
            'ripple': 'XRP',
            'cardano': 'ADA',
            'solana': 'SOL',
            'polkadot': 'DOT',
            'dogecoin': 'DOGE'
        };

        // Nombres completos de las criptomonedas
        const coinNames = {
            'bitcoin': 'Bitcoin',
            'ethereum': 'Ethereum',
            'binancecoin': 'Binance Coin',
            'ripple': 'Ripple',
            'cardano': 'Cardano',
            'solana': 'Solana',
            'polkadot': 'Polkadot',
            'dogecoin': 'Dogecoin'
        };

        // Procesar parámetros de la URL
        function processUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            selectedCoin = urlParams.get('coin') || 'bitcoin';
            tradeAction = urlParams.get('action') || 'buy';
            const price = parseFloat(urlParams.get('price')) || basePrices[selectedCoin];
            
            // Actualizar el precio actual
            appState.currentPrice = price;
            
            // Actualizar la interfaz según los parámetros
            updateUIFromParams();
        }

        // Actualizar la interfaz según los parámetros
        function updateUIFromParams() {
            // Actualizar el nombre del par
            document.getElementById('pair-name').textContent = 
                `${coinSymbols[selectedCoin]}/USDT`;
            
            // Establecer el precio por defecto
            document.getElementById('price').value = appState.currentPrice.toFixed(5);
            
            // Actualizar textos de botones
            document.getElementById('buy-btn').textContent = 
                `Comprar ${coinSymbols[selectedCoin]}`;
            document.getElementById('sell-btn').textContent = 
                `Vender ${coinSymbols[selectedCoin]}`;
            
            // Actualizar información de balance
            updateBalanceInfo();
            
            // Iniciar la simulación en tiempo real
            startRealTimeSimulation();
        }

        // Iniciar simulación en tiempo real
        function startRealTimeSimulation() {
            // Detener intervalos existentes
            if (updateInterval) clearInterval(updateInterval);
            if (priceUpdateInterval) clearInterval(priceUpdateInterval);
            
            // Generar datos iniciales
            generateOrders();
            generatePriceHistory();
            updatePriceChange();
            
            // Iniciar intervalos para actualización en tiempo real
            updateInterval = setInterval(() => {
                updateOrders();
                updateChart();
            }, 2000); // Actualizar cada 2 segundos
            
            priceUpdateInterval = setInterval(() => {
                updatePrice();
                updatePriceChange();
            }, 1000); // Actualizar precio cada segundo
        }

        // Calcular Media Móvil Exponencial (EMA)
        function calculateEMA(data, period) {
            if (data.length < period) return Array(data.length).fill(null);
            
            const k = 2 / (period + 1);
            const ema = [];
            
            // Calcular SMA inicial
            let sma = 0;
            for (let i = 0; i < period; i++) {
                sma += data[i].value;
            }
            sma /= period;
            ema[period - 1] = sma;
            
            // Calcular EMA para los puntos restantes
            for (let i = period; i < data.length; i++) {
                ema[i] = (data[i].value * k) + (ema[i - 1] * (1 - k));
            }
            
            // Rellenar con null los primeros puntos donde no hay EMA
            for (let i = 0; i < period - 1; i++) {
                ema[i] = null;
            }
            
            return ema;
        }

        // Generar historial de precios
        function generatePriceHistory() {
            const now = Date.now();
            appState.priceHistory = [];
            
            // Generar 100 puntos de datos
            for (let i = 100; i > 0; i--) {
                const time = new Date(now - i * 60000); // 1 minuto entre puntos
                // Precio inicial con variación aleatoria
                const price = appState.currentPrice * (0.99 + Math.random() * 0.02);
                appState.priceHistory.push({
                    time: time,
                    value: price
                });
            }
            
            // Inicializar gráfico
            initChart();
        }

        // Actualizar precio actual
        function updatePrice() {
            // Simular cambio de precio (variación de ±0.5%)
            const changePercent = (Math.random() - 0.5) * 0.01;
            appState.currentPrice = appState.currentPrice * (1 + changePercent);
            
            // Actualizar campo de precio si no está enfocado
            if (document.getElementById('price') !== document.activeElement) {
                document.getElementById('price').value = appState.currentPrice.toFixed(5);
            }
            
            // Añadir nuevo punto al historial
            appState.priceHistory.push({
                time: new Date(),
                value: appState.currentPrice
            });
            
            // Mantener sólo los últimos 100 puntos
            if (appState.priceHistory.length > 100) {
                appState.priceHistory.shift();
            }
            
            // Actualizar total si la cantidad está establecida
            calculateTotal();
        }

        // Actualizar cambio de precio
        function updatePriceChange() {
            if (appState.priceHistory.length < 2) return;
            
            const currentPrice = appState.priceHistory[appState.priceHistory.length - 1].value;
            const previousPrice = appState.priceHistory[0].value;
            const changePercent = ((currentPrice - previousPrice) / previousPrice) * 100;
            
            appState.priceChange24h = changePercent;
            
            const changeElement = document.getElementById('price-change');
            changeElement.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
            changeElement.className = `pair-change ${changePercent >= 0 ? 'change-positive' : 'change-negative'}`;
        }

        // Generar órdenes de compra y venta
        function generateOrders() {
            const price = appState.currentPrice;
            
            // Generar órdenes de compra (precios menores al actual)
            appState.buyOrders = [];
            for (let i = 10; i >= 1; i--) {
                const orderPrice = price * (1 - i * 0.001);
                const amount = (0.1 * i * (0.8 + Math.random() * 0.4)).toFixed(5);
                const total = (orderPrice * amount).toFixed(2);
                appState.buyOrders.push({ 
                    price: orderPrice, 
                    amount: amount,
                    total: total
                });
            }
            
            // Generar órdenes de venta (precios mayores al actual)
            appState.sellOrders = [];
            for (let i = 1; i <= 10; i++) {
                const orderPrice = price * (1 + i * 0.001);
                const amount = (0.1 * i * (0.8 + Math.random() * 0.4)).toFixed(5);
                const total = (orderPrice * amount).toFixed(2);
                appState.sellOrders.push({ 
                    price: orderPrice, 
                    amount: amount,
                    total: total
                });
            }
            
            renderOrders();
        }

        // Actualizar órdenes (simular cambios en tiempo real)
        function updateOrders() {
            // Modificar ligeramente las órdenes existentes
            appState.buyOrders.forEach(order => {
                // Pequeña variación en cantidad (±10%)
                const amountChange = 1 + (Math.random() - 0.5) * 0.2;
                order.amount = (order.amount * amountChange).toFixed(5);
                order.total = (order.price * order.amount).toFixed(2);
            });
            
            appState.sellOrders.forEach(order => {
                // Pequeña variación en cantidad (±10%)
                const amountChange = 1 + (Math.random() - 0.5) * 0.2;
                order.amount = (order.amount * amountChange).toFixed(5);
                order.total = (order.price * order.amount).toFixed(2);
            });
            
            // Ocasionalmente añadir o eliminar órdenes
            if (Math.random() > 0.7) {
                if (appState.buyOrders.length > 5 && Math.random() > 0.5) {
                    appState.buyOrders.shift(); // Eliminar primera orden
                } else {
                    // Añadir nueva orden
                    const newPrice = appState.currentPrice * (1 - (appState.buyOrders.length + 1) * 0.001);
                    const amount = (0.1 * (appState.buyOrders.length + 1) * (0.8 + Math.random() * 0.4)).toFixed(5);
                    const total = (newPrice * amount).toFixed(2);
                    appState.buyOrders.push({ 
                        price: newPrice, 
                        amount: amount,
                        total: total
                    });
                }
            }
            
            if (Math.random() > 0.7) {
                if (appState.sellOrders.length > 5 && Math.random() > 0.5) {
                    appState.sellOrders.pop(); // Eliminar última orden
                } else {
                    // Añadir nueva orden
                    const newPrice = appState.currentPrice * (1 + (appState.sellOrders.length + 1) * 0.001);
                    const amount = (0.1 * (appState.sellOrders.length + 1) * (0.8 + Math.random() * 0.4)).toFixed(5);
                    const total = (newPrice * amount).toFixed(2);
                    appState.sellOrders.push({ 
                        price: newPrice, 
                        amount: amount,
                        total: total
                    });
                }
            }
            
            renderOrders();
        }

        // Renderizar órdenes de compra y venta
        function renderOrders() {
            const buyOrdersContainer = document.getElementById('buy-orders');
            const sellOrdersContainer = document.getElementById('sell-orders');
            
            // Limpiar contenedores
            buyOrdersContainer.innerHTML = '';
            sellOrdersContainer.innerHTML = '';
            
            // Renderizar órdenes de compra
            appState.buyOrders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="buy-price">${order.price.toFixed(5)}</td>
                    <td>${order.amount}</td>
                    <td>${order.total}</td>
                `;
                buyOrdersContainer.appendChild(row);
            });
            
            // Renderizar órdenes de venta
            appState.sellOrders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="sell-price">${order.price.toFixed(5)}</td>
                    <td>${order.amount}</td>
                    <td>${order.total}</td>
                `;
                sellOrdersContainer.appendChild(row);
            });
        }

        // Inicializar gráfico
        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            // Calcular EMA
            const ema9 = calculateEMA(appState.priceHistory, 9);
            const ema21 = calculateEMA(appState.priceHistory, 21);
            
            const datasets = [{
                label: `${coinSymbols[selectedCoin]}/USDT`,
                data: appState.priceHistory.map(d => d.value),
                borderColor: '#0ecb81',
                backgroundColor: 'rgba(14, 203, 129, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.1,
                pointRadius: 0,
                pointHoverRadius: 3
            }];
            
            // Añadir EMA si está activado
            if (appState.showEMA) {
                datasets.push({
                    label: 'EMA 9',
                    data: ema9,
                    borderColor: '#3b82f6',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.1
                });
                
                datasets.push({
                    label: 'EMA 21',
                    data: ema21,
                    borderColor: '#8b5cf6',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.1
                });
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: appState.priceHistory.map(d => d.time.toLocaleTimeString()),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#848e9c',
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toFixed(5)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(42, 54, 83, 0.5)'
                            },
                            ticks: {
                                color: '#848e9c',
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(42, 54, 83, 0.5)'
                            },
                            ticks: {
                                color: '#848e9c',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
            
            // Dibujar marcadores de trades
            drawTradeMarkers();
        }

        // Actualizar gráfico
        function updateChart() {
            if (!chart) return;
            
            // Calcular EMA
            const ema9 = calculateEMA(appState.priceHistory, 9);
            const ema21 = calculateEMA(appState.priceHistory, 21);
            
            chart.data.labels = appState.priceHistory.map(d => d.time.toLocaleTimeString());
            chart.data.datasets[0].data = appState.priceHistory.map(d => d.value);
            
            // Actualizar EMA si está activado
            if (appState.showEMA) {
                if (chart.data.datasets.length === 1) {
                    // Añadir EMA si no estaba presente
                    chart.data.datasets.push({
                        label: 'EMA 9',
                        data: ema9,
                        borderColor: '#3b82f6',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false,
                        tension: 0.1
                    });
                    
                    chart.data.datasets.push({
                        label: 'EMA 21',
                        data: ema21,
                        borderColor: '#8b5cf6',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false,
                        tension: 0.1
                    });
                } else {
                    // Actualizar EMA existente
                    chart.data.datasets[1].data = ema9;
                    chart.data.datasets[2].data = ema21;
                }
            } else {
                // Eliminar EMA si está desactivado
                if (chart.data.datasets.length > 1) {
                    chart.data.datasets = [chart.data.datasets[0]];
                }
            }
            
            chart.update('quiet');
            
            // Actualizar marcadores de trades
            drawTradeMarkers();
        }

        // Dibujar marcadores de trades en el gráfico
        function drawTradeMarkers() {
            // Limpiar marcadores existentes
            document.querySelectorAll('.trade-marker').forEach(marker => marker.remove());
            
            // Obtener el canvas y su contexto
            const canvas = document.getElementById('priceChart');
            const chartArea = chart.chartArea;
            
            // Dibujar marcadores para cada trade
            appState.tradeHistory.forEach(trade => {
                // Encontrar el índice del trade en el historial de precios
                const index = appState.priceHistory.findIndex(p => 
                    p.time.getTime() === trade.timestamp.getTime());
                
                if (index !== -1) {
                    const x = chart.scales.x.getPixelForValue(index);
                    const y = chart.scales.y.getPixelForValue(trade.price);
                    
                    // Crear marcador solo si están dentro del área visible
                    if (x >= chartArea.left && x <= chartArea.right && 
                        y >= chartArea.top && y <= chartArea.bottom) {
                        
                        const marker = document.createElement('div');
                        marker.className = `trade-marker ${trade.type === 'BUY' ? 'buy-marker' : 'sell-marker'}`;
                        marker.style.position = 'absolute';
                        marker.style.left = `${x - 5}px`;
                        marker.style.top = `${y - 5}px`;
                        marker.title = `${trade.type} ${trade.amount} @ $${trade.price}`;
                        
                        canvas.parentNode.appendChild(marker);
                    }
                }
            });
        }

        // Renderizar posiciones abiertas
        function renderPositions() {
            const positionsContainer = document.getElementById('positions-container');
            positionsContainer.innerHTML = '';
            
            if (appState.positions.length === 0) {
                positionsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #848e9c;">No hay posiciones abiertas</div>';
                return;
            }
            
            appState.positions.forEach((position, index) => {
                const profit = (appState.currentPrice - position.entryPrice) * position.amount;
                const profitPercent = (profit / (position.entryPrice * position.amount)) * 100;
                
                const positionEl = document.createElement('div');
                positionEl.className = 'position-card';
                positionEl.innerHTML = `
                    <div class="position-info">
                        <div class="position-pair">${position.pair}</div>
                        <div class="position-details">
                            ${position.type} • ${position.amount} ${coinSymbols[selectedCoin]} • ${position.entryPrice.toFixed(5)}
                        </div>
                    </div>
                    <div class="position-profit ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                        ${profit >= 0 ? '+' : ''}${profit.toFixed(2)} USDT<br>
                        <small>${profitPercent.toFixed(2)}%</small>
                    </div>
                    <button class="close-btn" data-index="${index}">×</button>
                `;
                
                positionsContainer.appendChild(positionEl);
            });
            
            // Añadir event listeners a los botones de cierre
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    closePosition(index);
                });
            });
        }

        // Cerrar posición
        function closePosition(index) {
            if (index >= 0 && index < appState.positions.length) {
                const position = appState.positions[index];
                const profit = (appState.currentPrice - position.entryPrice) * position.amount;
                
                // Actualizar balance
                appState.balance += profit;
                
                // Añadir al historial
                appState.tradeHistory.push({
                    pair: position.pair,
                    type: position.type === 'LONG' ? 'CLOSE_LONG' : 'CLOSE_SHORT',
                    entryPrice: position.entryPrice,
                    exitPrice: appState.currentPrice,
                    amount: position.amount,
                    profit: profit,
                    timestamp: new Date()
                });
                
                // Añadir marcador en el gráfico
                addTradeMarker(position.type === 'LONG' ? 'SELL' : 'BUY', appState.currentPrice, new Date());
                
                // Eliminar posición
                appState.positions.splice(index, 1);
                
                // Actualizar UI
                updateBalanceInfo();
                renderPositions();
                drawTradeMarkers();
            }
        }

        // Añadir marcador de trade al gráfico
        function addTradeMarker(type, price, timestamp) {
            appState.tradeMarkers.push({
                type: type,
                price: price,
                timestamp: timestamp
            });
        }

        // Actualizar información de balance y ganancias
        function updateBalanceInfo() {
            // Calcular ganancia/pérdida total de posiciones abiertas
            let totalProfit = 0;
            appState.positions.forEach(position => {
                totalProfit += (appState.currentPrice - position.entryPrice) * position.amount;
            });
            
            // Calcular ganancia/pérdida total del historial
            let historyProfit = 0;
            appState.tradeHistory.forEach(trade => {
                historyProfit += trade.profit || 0;
            });
            
            const totalBalance = initialData.balance + totalProfit + historyProfit;
            
            document.getElementById('profit-loss').textContent = `$${(totalProfit + historyProfit).toFixed(2)}`;
            document.getElementById('return').textContent = `${((totalProfit + historyProfit) / initialData.balance * 100).toFixed(2)}%`;
            document.getElementById('balance-display').textContent = `Balance: $${totalBalance.toFixed(2)}`;
            
            // Actualizar información de balance con la criptomoneda seleccionada
            const coinBalance = appState[selectedCoin + 'Balance'] || 0;
            document.getElementById('available-usdt').textContent = totalBalance.toFixed(2);
            document.getElementById('available-crypto').textContent = `${coinBalance.toFixed(6)} ${coinSymbols[selectedCoin]}`;
        }

        // Calcular total al cambiar precio o cantidad
        function calculateTotal() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const total = price * amount;
            
            document.getElementById('total').value = total.toFixed(2);
        }

        // Ejecutar una orden de compra
        function executeBuyOrder() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const total = price * amount;
            
            if (total > appState.balance) {
                alert('Saldo insuficiente');
                return;
            }
            
            if (price <= 0 || amount <= 0) {
                alert('Precio o cantidad inválidos');
                return;
            }
            
            // Actualizar balances
            appState.balance -= total;
            // Usar el nombre de la criptomoneda en lugar de "bnbBalance"
            if (!appState[selectedCoin + 'Balance']) {
                appState[selectedCoin + 'Balance'] = 0;
            }
            appState[selectedCoin + 'Balance'] += amount;
            
            // Añadir a posiciones
            appState.positions.push({
                pair: `${coinSymbols[selectedCoin]}/USDT`,
                type: 'LONG',
                entryPrice: price,
                amount: amount,
                timestamp: new Date(),
                coin: selectedCoin
            });
            
            // Añadir al historial
            appState.tradeHistory.push({
                pair: `${coinSymbols[selectedCoin]}/USDT`,
                type: 'BUY',
                price: price,
                amount: amount,
                total: total,
                timestamp: new Date()
            });
            
            // Añadir marcador en el gráfico
            addTradeMarker('BUY', price, new Date());
            
            // Actualizar UI
            updateBalanceInfo();
            renderPositions();
            drawTradeMarkers();
            
            alert(`Orden ejecutada: Compra de ${amount} ${coinSymbols[selectedCoin]} a $${price} cada uno. Total: $${total.toFixed(2)}`);
        }

        // Ejecutar una orden de venta
        function executeSellOrder() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const total = price * amount;
            
            const coinBalance = appState[selectedCoin + 'Balance'] || 0;
            
            if (amount > coinBalance) {
                alert(`Saldo de ${coinSymbols[selectedCoin]} insuficiente`);
                return;
            }
            
            if (price <= 0 || amount <= 0) {
                alert('Precio o cantidad inválidos');
                return;
            }
            
            // Actualizar balances
            appState.balance += total;
            appState[selectedCoin + 'Balance'] -= amount;
            
            // Añadir a posiciones (como venta)
            appState.positions.push({
                pair: `${coinSymbols[selectedCoin]}/USDT`,
                type: 'SHORT',
                entryPrice: price,
                amount: amount,
                timestamp: new Date(),
                coin: selectedCoin
            });
            
            // Añadir al historial
            appState.tradeHistory.push({
                pair: `${coinSymbols[selectedCoin]}/USDT`,
                type: 'SELL',
                price: price,
                amount: amount,
                total: total,
                timestamp: new Date()
            });
            
            // Añadir marcador en el gráfico
            addTradeMarker('SELL', price, new Date());
            
            // Actualizar UI
            updateBalanceInfo();
            renderPositions();
            drawTradeMarkers();
            
            alert(`Orden ejecutada: Venta de ${amount} ${coinSymbols[selectedCoin]} a $${price} cada uno. Total: $${total.toFixed(2)}`);
        }

        // Cambiar timeframe del gráfico
        function changeTimeframe(timeframe) {
            appState.timeframe = timeframe;
            
            // Aquí podrías ajustar cómo se generan/actualizan los datos según el timeframe
            // Por ahora simplemente reiniciamos la simulación
            startRealTimeSimulation();
        }

        // Alternar indicadores
        function toggleIndicator(indicator) {
            if (indicator === 'ema') {
                appState.showEMA = !appState.showEMA;
                document.querySelector('[data-indicator="ema"]').classList.toggle('active', appState.showEMA);
                updateChart();
            }
        }

        // Inicializar la aplicación
        function initApp() {
            processUrlParams(); // Procesar parámetros primero
            
            // Event listeners
            document.getElementById('price').addEventListener('input', calculateTotal);
            document.getElementById('amount').addEventListener('input', calculateTotal);
            document.getElementById('buy-btn').addEventListener('click', executeBuyOrder);
            document.getElementById('sell-btn').addEventListener('click', executeSellOrder);
        
            // Cambiar tipo de orden
            document.querySelectorAll('.trade-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.trade-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    tradeAction = this.getAttribute('data-type');
                });
            });
            
            // Cambiar timeframe
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    changeTimeframe(this.getAttribute('data-timeframe'));
                });
            });
            
            // Alternar indicadores
            document.querySelectorAll('.indicator-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    toggleIndicator(this.getAttribute('data-indicator'));
                });
            });
        }

        // Ejecutar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>